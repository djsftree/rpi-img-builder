#!/bin/bash

run_function1 (){

  # remove kernel install from stage2
  sed -i 's/stage2_kernel/#stage2_kernel/g' p2/root/stage2
  
}



run_function2 (){


  mkdir -p /home/${USERNAME}/dev
  CFLAGS="-march=armv8-a+crc+crypto -mtune=cortex-a72"

  # dpkg-build tuning flags for rpi4
  echo "APPEND CFLAGS ${CFLAGS}" >> /etc/dpkg/buildflags.conf
  echo "APPEND CXXFLAGS ${CFLAGS}" >> /etc/dpkg/buildflags.conf

  # onboard keyboard defaults
  mv -f /root/userscripts/lightdm.conf /etc/lightdm/lightdm.conf
  mv -f /root/userscripts/lightdm-gtk-greeter.conf /etc/lightdm/lightdm-gtk-greeter.conf

  # theme defaults



  # install kernel
  stage2_kernel



  # install EtherCAT
  apt install -y --no-install-recommends dkms
  dpkg -i /root/userscripts/dpkg/ethercat-dkms_1.5.2-33_all.deb
  dpkg -i /root/userscripts/dpkg/libethercat_1.5.2-33_arm64.deb
  dpkg -i /root/userscripts/dpkg/libethercat-dev_1.5.2-33_arm64.deb
  dpkg -i /root/userscripts/dpkg/ethercat-master_1.5.2-33_arm64.deb
  systemctl enable ethercat.service
  echo 'KERNEL=="EtherCAT[0-9]", MODE="0777"' > /etc/udev/rules.d/99-ethercat.rules



  # LinuxCNC
  echo ""
  echo "Installing LinuxCNC ..."
  sleep 1s
  apt install -y linuxcnc-uspace linuxcnc-uspace-dev mesaflash
  dpkg -i /root/userscripts/dpkg/linuxcnc-uspace_*arm64.deb
  dpkg -i /root/userscripts/dpkg/linuxcnc-uspace-dev_*arm64.deb



  # LinuxCNC-EtherCAT
  echo ""
  echo "Installing LinuxCNC-EtherCAT..."
  sleep 1s
  cd /home/${USERNAME}/dev
  git clone https://github.com/sittner/linuxcnc-ethercat.git
  mv -f /root/userscripts/realtime.mk linuxcnc-ethercat/src/realtime.mk
  cd linuxcnc-ethercat
  make -j4
  make install
  echo 'KERNEL=="EtherCAT[0-9]", MODE="0777"' > /etc/udev/rules.d/99-ethercat.rules



  # Qtpyvcp support
  echo ""
  echo "Installing qtpyvcp ..."
  sleep 1s
  pip install /root/userscripts/vtk-*.whl
  cd /home/${USERNAME}/dev
  git clone https://github.com/kcjengr/qtpyvcp
  cd qtpyvcp
  cp scripts/.xsessionrc /home/${USERNAME}/
  chown -R ${USERNAME}:${USERNAME} /home/${USERNAME}
  sudo -u ${USERNAME} python3 -m pip install -e .
  cp -r linuxcnc /home/${USERNAME}/



  # Tidy up
  echo ""
  echo "Tidying up"
  sleep 1s  
  chown -R ${USERNAME}:${USERNAME} /home/${USERNAME}
  apt -y clean
  apt -y autoclean
}
